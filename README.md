# 蝴蝶孵化箱控制系统

基于ESP32-C3的智能温湿度控制系统，用于蝴蝶卵和幼虫的孵化环境管理。

## 📚 文档导航

- **[快速开始指南](QUICK_START.md)** - 快速搭建和运行系统
- **[接线图说明](WIRING_DIAGRAM.md)** - 详细的硬件连接说明
- **[Blynk配置指南](BLYNK_SETUP.md)** - 手机APP配置教程
- **[库文件列表](libraries.txt)** - 所需Arduino库列表

## 硬件清单

- **ESP32-C3** - 主控制器
- **AM2302** - 温湿度传感器
- **OLED 0.96 SSD1306** - 显示屏
- **继电器模块 x2** - 控制加热垫和加湿器
- **220V加热垫** - 温度控制
- **5V电风扇** - 降温
- **加湿器** - 湿度控制
- **按键 x3** - 本地设置（设置、增加、减少）

## 功能特性

- ✅ 自动温湿度控制（PID控制逻辑）
- ✅ OLED实时显示温湿度曲线
- ✅ 本地按键设置目标温湿度
- ✅ Blynk手机APP远程监控和控制
- ✅ WiFi自动配置（WiFiManager）
- ✅ 数据历史记录和曲线显示

## 接线说明

### ESP32-C3引脚连接

**重要提示：** ESP32-C3的GPIO编号与ESP32不同，请按照以下引脚连接：

| 组件 | 引脚 | 说明 |
|------|------|------|
| AM2302 DATA | GPIO 2 | 温湿度传感器数据线（需要上拉电阻4.7kΩ） |
| OLED SDA | GPIO 4 | I2C数据线 |
| OLED SCL | GPIO 5 | I2C时钟线 |
| 加热继电器 | GPIO 6 | 控制220V加热垫 |
| 加湿继电器 | GPIO 7 | 控制加湿器 |
| 风扇 | GPIO 10 | PWM控制5V风扇 |
| 设置按键 | GPIO 0 | 切换设置模式（注意：某些板子GPIO0是BOOT按钮） |
| 增加按键 | GPIO 1 | 增加数值 |
| 减少按键 | GPIO 3 | 减少数值 |

**引脚选择说明：**
- GPIO 8和GPIO 9通常用于USB通信，避免使用
- GPIO 0在某些开发板上是BOOT按钮，如果使用该引脚，可能需要调整
- 所有按键使用内部上拉电阻（INPUT_PULLUP模式）
- AM2302需要外部4.7kΩ上拉电阻连接到VCC

### 继电器连接

**重要安全提示：**
- 220V电路连接需要专业电工操作
- 确保所有高压连接牢固可靠
- 使用合适的继电器（建议10A以上）
- 加热垫和加湿器必须通过继电器控制，不要直接连接ESP32

**继电器接线：**
- 继电器常开端（NO）连接加热垫/加湿器火线
- 继电器公共端（COM）连接电源火线
- 零线直接连接设备

## 软件安装

### 1. 安装Arduino IDE

下载并安装 [Arduino IDE](https://www.arduino.cc/en/software)

### 2. 安装ESP32开发板支持

1. 打开Arduino IDE
2. 文件 → 首选项 → 附加开发板管理器网址
3. 添加：`https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json`
4. 工具 → 开发板 → 开发板管理器
5. 搜索"ESP32"并安装

### 3. 安装所需库

在Arduino IDE中，通过库管理器安装以下库：

- **Blynk** (版本 1.2.0) - 物联网平台
- **DHT sensor library** (Adafruit) - 温湿度传感器
- **Adafruit GFX Library** - 图形库
- **Adafruit SSD1306** - OLED显示屏
- **WiFiManager** (tzapu) - WiFi自动配置

安装方法：
1. 工具 → 管理库
2. 搜索库名称
3. 点击安装

### 4. 配置Blynk

1. 在手机上下载并安装 **Blynk** APP
2. 注册账号并创建新项目
3. 选择硬件为 **ESP32**
4. 连接类型选择 **WiFi**
5. 复制 **Auth Token** 到代码中

#### Blynk虚拟引脚配置

在Blynk APP中添加以下控件（建议布局）：

**输入控件（用于设置）：**
| 虚拟引脚 | 控件类型 | 设置 | 说明 |
|----------|----------|------|------|
| V0 | 滑块 | 最小值: 10, 最大值: 40, 步进: 0.5 | 目标温度设置（°C） |
| V1 | 滑块 | 最小值: 20, 最大值: 95, 步进: 5 | 目标湿度设置（%） |

**显示控件（用于监控）：**
| 虚拟引脚 | 控件类型 | 设置 | 说明 |
|----------|----------|------|------|
| V2 | 超级图表 | 数据流: V2 | 当前温度实时曲线 |
| V2 | 标签/仪表 | 范围: 0-50 | 当前温度显示（°C） |
| V3 | 超级图表 | 数据流: V3 | 当前湿度实时曲线 |
| V3 | 标签/仪表 | 范围: 0-100 | 当前湿度显示（%） |
| V4 | 标签 | - | 目标温度显示（°C） |
| V5 | 标签 | - | 目标湿度显示（%） |
| V6 | LED | - | 加热状态指示（ON/OFF） |
| V7 | LED | - | 加湿状态指示（ON/OFF） |

**Blynk APP设置步骤：**
1. 打开Blynk APP，创建新项目
2. 选择硬件：**ESP32**
3. 连接类型：**WiFi**
4. 复制Auth Token到代码中
5. 按照上表添加控件并配置虚拟引脚
6. 建议使用超级图表（SuperChart）显示温湿度历史曲线

### 5. 修改代码配置

打开 `butterfly_incubator.ino`，修改以下内容：

```cpp
#define BLYNK_TEMPLATE_ID "YOUR_TEMPLATE_ID"
#define BLYNK_AUTH_TOKEN "YOUR_AUTH_TOKEN"
```

将 `YOUR_AUTH_TOKEN` 替换为Blynk APP中获取的认证令牌。

### 6. 选择开发板和端口

1. 工具 → 开发板 → ESP32 Arduino → **ESP32C3 Dev Module**
2. 工具 → 端口 → 选择ESP32-C3连接的COM端口（Windows）或/dev/ttyUSB0（Linux/Mac）
3. 工具 → Upload Speed → **921600**（或115200，如果921600失败）
4. 工具 → CPU Frequency → **160MHz**（推荐）
5. 工具 → Flash Size → **4MB**（根据你的板子选择）
6. 工具 → Partition Scheme → **Default 4MB with spiffs**（或Default）
7. 工具 → Core Debug Level → **None**（或Info用于调试）

### 7. 上传程序

点击上传按钮，等待编译和上传完成。

## 使用方法

### 首次启动

1. **上电后**，ESP32-C3会创建一个名为 `ButterflyIncubator` 的WiFi热点
2. **用手机或电脑连接该热点**（密码通常为空，或查看串口输出）
3. **浏览器会自动打开配置页面**（如果没有，手动访问 http://192.168.4.1）
4. **选择你的WiFi网络并输入密码**，点击保存
5. **等待连接成功**（OLED屏幕会显示IP地址）
6. **系统会自动连接到Blynk服务器**（如果配置了Auth Token）
7. **如果Blynk连接失败**，系统仍会继续运行，只是无法通过APP控制

**重新配置WiFi：**
- 如果需要重新配置WiFi，可以按住BOOT按钮（GPIO0）重启，或清除WiFi设置后重启
- 也可以使用WiFiManager的复位功能（在代码中添加）

### 本地按键操作

- **设置键**：按一次进入温度设置模式，再按进入湿度设置模式，再按退出设置
- **增加键**：在设置模式下增加数值（温度+0.5°C，湿度+5%）
- **减少键**：在设置模式下减少数值（温度-0.5°C，湿度-5%）
- **自动退出**：设置模式下10秒无操作自动退出

### OLED显示说明

**正常模式显示内容：**
- **第一行**：`T:25.5C T:26.0C` （当前温度 / 目标温度）
- **第二行**：`H:60% H:65%` （当前湿度 / 目标湿度）
- **第三行**：`H:ON M:OFF` （加热状态 / 加湿状态）
- **下半部分**：温湿度历史曲线图
  - 上半部分曲线（32-40像素）：温度曲线
  - 下半部分曲线（42-57像素）：湿度曲线
  - 数据每30秒记录一次，最多显示120个数据点（约1小时历史）

**设置模式显示：**
- **温度设置模式**：显示"设置温度"和当前目标温度值
- **湿度设置模式**：显示"设置湿度"和当前目标湿度值
- 10秒无操作自动退出设置模式

### Blynk APP使用

1. 打开Blynk APP
2. 选择你的项目
3. 可以实时查看温湿度
4. 可以远程设置目标温湿度
5. 可以查看设备工作状态

## 控制逻辑

### 温度控制
- 当前温度 < 目标温度 - 1°C：开启加热垫
- 当前温度 > 目标温度 + 1°C：关闭加热垫
- 当前温度 > 目标温度 + 3°C：风扇全速运行
- 当前温度 > 目标温度 + 1°C：风扇半速运行

### 湿度控制
- 当前湿度 < 目标湿度 - 5%：开启加湿器
- 当前湿度 > 目标湿度 + 5%：关闭加湿器

## 安全注意事项

⚠️ **重要安全提示**

1. **高压安全**：
   - 220V电路连接必须由专业电工完成
   - 确保所有连接牢固，无裸露导线
   - 使用符合规格的继电器（建议10A以上）
   - 安装漏电保护器

2. **防火安全**：
   - 加热垫不要直接接触易燃物
   - 定期检查线路和连接
   - 不要在无人看管时长时间运行

3. **设备保护**：
   - 确保加湿器有足够的水
   - 避免传感器受潮
   - 定期清洁传感器

## 故障排除

### WiFi连接失败
- 检查WiFi密码是否正确
- 确保WiFi信号强度足够
- 尝试重新配置（按住复位键重启）

### Blynk连接失败
- 检查Auth Token是否正确
- 确保设备已连接到互联网
- 检查Blynk服务器状态

### 传感器读取失败
- 检查AM2302接线是否正确（DATA引脚连接到GPIO2）
- **检查上拉电阻**：AM2302的DATA引脚需要4.7kΩ上拉电阻连接到VCC（3.3V）
- 检查传感器是否损坏（观察串口输出）
- 确保传感器供电正常（3.3V或5V，根据你的模块）
- 尝试更换传感器或检查传感器型号（AM2302等同于DHT22）

### OLED无显示
- 检查I2C接线（SDA连接到GPIO4，SCL连接到GPIO5）
- 检查OLED地址（默认0x3C，某些OLED可能是0x3D）
- 检查OLED供电（通常需要3.3V或5V）
- 检查I2C上拉电阻（通常OLED模块已内置）
- 如果使用其他I2C地址，修改代码中的`0x3C`为实际地址
- 尝试交换SDA和SCL线

## 参数调整

可以在代码中调整以下参数：

```cpp
float tempHysteresis = 1.0;    // 温度滞回（避免频繁开关）
float humHysteresis = 5.0;     // 湿度滞回
const unsigned long DATA_UPDATE_INTERVAL = 30000; // 数据更新间隔（毫秒）
```

## 许可证

本项目仅供学习和个人使用。

## 作者

蝴蝶孵化箱控制系统 v1.0

